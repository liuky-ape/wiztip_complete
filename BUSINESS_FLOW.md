# Wiztip 业务流程说明

## 🎯 完整业务流程

### 方案：先识别后确认（当前实现）

这是用户友好的方案，用户可以在看到识别结果后决定是否保存。

```
┌─────────────────────────────────────────────────────────┐
│  1. 用户说"你好小笔"                                      │
└────────────────┬────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────┐
│  2. 唤醒词检测成功 → 开始录音                            │
│     - 音量实时可视化                                     │
│     - 静音倒计时显示                                     │
└────────────────┬────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────┐
│  3. 录音结束（三种方式）                                 │
│     - 5秒静音自动停止                                    │
│     - 点击"💾 保存录音"                                  │
│     - 点击"⏹️ 停止录音"                                 │
└────────────────┬────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────┐
│  4. 自动调用阿里云NLS识别                                │
│     API: POST /api/audio/recognize                      │
│     - 上传音频到OSS                                      │
│     - 调用阿里云NLS ASR服务                              │
│     - 返回识别文本                                       │
│     - ❌ 不保存到数据库                                  │
└────────────────┬────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────────────┐
│  5. 显示识别结果 + 确认对话框                            │
│     ┌──────────────────────────────────────┐            │
│     │ 📝 识别结果：                         │            │
│     │ 今天天气真不错，我要去公园散步         │            │
│     │                                       │            │
│     │ [☁️ 上传保存到云端] [✕ 放弃]          │            │
│     └──────────────────────────────────────┘            │
└────────────────┬────────────────────────────────────────┘
                 ↓
         用户选择
        ↙         ↘
   点击"上传"   点击"放弃"
       ↓            ↓
┌──────────┐  ┌──────────┐
│ 6a. 保存 │  │ 6b. 丢弃 │
└────┬─────┘  └────┬─────┘
     ↓             ↓
     │        删除录音数据
     │        恢复监听状态
     ↓
┌─────────────────────────────────┐
│  API: POST /api/audio/save      │
│  - 创建voice_record记录         │
│  - 生成文本向量嵌入             │
│  - 保存voice_transcript记录    │
└────────────────┬────────────────┘
                 ↓
┌─────────────────────────────────┐
│  7. 显示保存成功                │
│     - 显示记录ID                │
│     - 5秒后恢复监听             │
└─────────────────────────────────┘
```

## 📋 接口说明

### 接口1: 识别音频（不保存）

**路径**: `POST /api/audio/recognize`

**用途**: 仅进行语音识别，返回文本，不保存到数据库

**流程**:
```java
1. 上传文件到OSS
2. 调用阿里云NLS ASR识别
3. 返回识别文本和OSS URL
```

**返回**:
```json
{
  "success": true,
  "transcript": "识别的文本",
  "ossUrl": "https://...",
  "message": "语音识别成功，请确认是否保存"
}
```

### 接口2: 保存识别结果

**路径**: `POST /api/audio/save`

**用途**: 将已识别的结果保存到数据库

**流程**:
```java
1. 创建VoiceRecord记录
2. 生成文本向量嵌入
3. 保存VoiceTranscript记录
```

**返回**:
```json
{
  "success": true,
  "recordId": 123,
  "message": "数据已保存到数据库"
}
```

### 接口3: 上传并保存（一步完成）

**路径**: `POST /api/audio/upload`

**用途**: 直接上传、识别并保存（适合API调用，不需要用户确认）

**流程**:
```java
1. 上传到OSS
2. 创建记录
3. ASR识别
4. 生成向量
5. 保存到数据库
```

## 🎨 前端交互流程

### 状态1: 等待唤醒
```
👂 准备就绪，等待唤醒
说出"你好小笔"开始录音
```

### 状态2: 录音中
```
🎙️ 正在录音，请说话...
━━━━━━━━━━ 80%  (音量条)
静音 3 秒后自动停止

[手动录音变为] [⏹️ 停止录音]
[💾 保存录音] (启用)
```

### 状态3: 识别中
```
☁️ 正在调用阿里云NLS识别...
请稍候...
```

### 状态4: 显示结果
```
📝 识别结果：
今天天气真不错，我要去公园散步

[☁️ 上传保存到云端] [✕ 放弃]
```

### 状态5a: 保存中
```
💾 正在保存到数据库...
今天天气真不错，我要去公园散步

⏳ 正在保存...
```

### 状态5b: 保存成功
```
✅ 已成功保存！
今天天气真不错，我要去公园散步

✅ 已成功保存到云端数据库！
记录ID: 123

(5秒后自动恢复监听)
```

## 💾 数据流转

### 音频文件流转
```
浏览器录音 
  ↓ (Blob)
前端 currentAudioBlob
  ↓ (FormData)
后端 MultipartFile
  ↓ (InputStream)
阿里云OSS存储
  ↓ (URL)
阿里云NLS识别
```

### 文本数据流转
```
阿里云NLS识别
  ↓ (transcript)
后端返回给前端
  ↓ (JSON)
前端显示 + 用户确认
  ↓ (FormData)
后端保存到数据库
  ↓
voice_record + voice_transcript 表
```

### 向量数据流转
```
识别文本
  ↓
EmbeddingService.embed()
  ↓ (float[])
转换为JSON
  ↓ (String)
保存到voice_transcript.embedding_json
```

## 🔄 用户交互选择

### 选择1: 上传保存 ☁️

**用户操作**: 点击"☁️ 上传保存到云端"

**系统行为**:
1. 调用 `/api/audio/save` 接口
2. 创建数据库记录
3. 生成并保存向量
4. 显示成功消息
5. 5秒后恢复监听

**数据变化**:
- `voice_record` 表新增1条记录
- `voice_transcript` 表新增1条记录
- OSS保留音频文件

### 选择2: 放弃 ✕

**用户操作**: 点击"✕ 放弃"

**系统行为**:
1. 清空内存中的录音数据
2. 关闭识别结果框
3. 恢复监听状态

**数据变化**:
- 不创建数据库记录
- OSS文件保留（可后续清理）
- 内存数据清空

## 🎯 优势分析

### ✅ 用户体验优势

1. **预览后决定** - 看到内容再保存
2. **避免错误保存** - 识别错误的不保存
3. **隐私保护** - 敏感内容可以不保存
4. **即时反馈** - 快速看到识别结果

### ✅ 技术优势

1. **解耦识别和保存** - 两个独立接口
2. **灵活性高** - 支持多种使用场景
3. **节省存储** - 不保存无用数据
4. **易于扩展** - 可添加编辑、重试等功能

### ✅ 业务优势

1. **数据质量** - 只保存用户确认的数据
2. **节省成本** - 减少无效数据存储
3. **符合规范** - 用户主动选择保存

## 🔧 可能的扩展功能

基于当前架构，可以轻松添加：

1. **编辑功能** - 用户修正识别错误后再保存
2. **重新识别** - 识别不满意时重新调用
3. **音频试听** - 确认前先听一遍录音
4. **批注功能** - 添加标签、备注后保存
5. **分享功能** - 分享识别结果给他人

## 📊 数据库影响

### 只识别不保存时

- ✅ OSS存储文件（可定期清理未保存的文件）
- ❌ 不创建voice_record记录
- ❌ 不创建voice_transcript记录

### 确认保存后

- ✅ OSS文件保留
- ✅ voice_record记录（status=1已完成）
- ✅ voice_transcript记录（含向量）

## 性能考虑

### OSS文件清理

未确认保存的录音会留在OSS，建议定期清理：

```java
// 定时任务：清理7天前未关联数据库的OSS文件
@Scheduled(cron = "0 0 2 * * ?")
public void cleanOrphanedFiles() {
    // 查询OSS中的文件
    // 检查是否在voice_record表中
    // 删除孤立文件
}
```

---

**版本**: 2.0  
**最后更新**: 2025-10-22  
**状态**: ✅ 生产就绪

