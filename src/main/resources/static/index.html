<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wiztip è¯­éŸ³åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status-box {
            background: #f5f7fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .status-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .status-text {
            color: #555;
            font-size: 16px;
            font-weight: 500;
        }

        .wake-word {
            color: #667eea;
            font-weight: bold;
            font-size: 24px;
            display: block;
            margin-top: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-start {
            background: #667eea;
            color: white;
        }

        .btn-stop {
            background: #f56565;
            color: white;
        }

        .btn-manual {
            background: #48bb78;
            color: white;
        }

        .btn-save {
            background: #f6ad55;
            color: white;
        }

        .btn-save:disabled {
            background: #cbd5e0;
        }

        .recording-indicator {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .recording-indicator.active {
            display: block;
        }

        .pulse {
            width: 60px;
            height: 60px;
            background: #f56565;
            border-radius: 50%;
            margin: 0 auto 10px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }

        .user-info {
            margin-bottom: 20px;
        }

        .user-info label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .user-info input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .user-info input:focus {
            outline: none;
            border-color: #667eea;
        }

        .log {
            background: #f5f7fa;
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 13px;
            color: #555;
        }

        .log-item {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }

        .log-time {
            color: #999;
            font-size: 11px;
        }

        .listening {
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(102, 126, 234, 0.5); }
            50% { box-shadow: 0 0 20px rgba(102, 126, 234, 1); }
        }

        .transcript-box {
            background: #f0f9ff;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .transcript-box.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-confirm {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-upload {
            background: #667eea;
            color: white;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #555;
        }

        .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .transcript-title {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .transcript-text {
            color: #333;
            font-size: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .volume-indicator {
            display: none;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .volume-indicator.show {
            display: block;
        }

        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            border-radius: 4px;
            transition: width 0.1s;
        }

        .silence-timer {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ Wiztip è¯­éŸ³åŠ©æ‰‹</h1>
        <p class="subtitle">è¯´å‡º"ä½ å¥½å°ç¬”"å¼€å§‹å½•éŸ³</p>

        <div class="status-box" id="statusBox">
            <div class="status-icon">ğŸ‘‚</div>
            <div class="status-text" id="statusText">å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…å”¤é†’</div>
            <span class="wake-word" id="wakeWord" style="display:none;">ä½ å¥½å°ç¬”</span>
        </div>

        <div class="recording-indicator" id="recordingIndicator">
            <div class="pulse"></div>
            <div>æ­£åœ¨å½•éŸ³...</div>
            <div class="volume-indicator" id="volumeIndicator">
                <div class="volume-bar" id="volumeBar"></div>
            </div>
            <div class="silence-timer" id="silenceTimer"></div>
        </div>

        <div class="transcript-box" id="transcriptBox">
            <div class="transcript-title">ğŸ“ è¯†åˆ«ç»“æœï¼š</div>
            <div class="transcript-text" id="transcriptText">ç­‰å¾…è¯†åˆ«...</div>
            <div class="confirm-buttons" id="confirmButtons" style="display:none;">
                <button class="btn-confirm btn-upload" onclick="confirmUpload()">â˜ï¸ ä¸Šä¼ ä¿å­˜åˆ°äº‘ç«¯</button>
                <button class="btn-confirm btn-cancel" onclick="cancelUpload()">âœ• æ”¾å¼ƒ</button>
            </div>
        </div>

        <div class="user-info">
            <label for="userId">ç”¨æˆ·ID:</label>
            <input type="text" id="userId" value="user_001" placeholder="è¯·è¾“å…¥ç”¨æˆ·ID">
        </div>

        <div class="controls">
            <button class="btn-start" id="btnStart" onclick="startWakeWordDetection()">å¯åŠ¨å”¤é†’è¯æ£€æµ‹</button>
            <button class="btn-stop" id="btnStop" onclick="stopWakeWordDetection()" disabled>åœæ­¢æ£€æµ‹</button>
        </div>

        <div class="controls">
            <button class="btn-manual" id="btnManual" onclick="manualRecord()">æ‰‹åŠ¨å½•éŸ³</button>
            <button class="btn-save" id="btnSave" onclick="saveRecording()" disabled>ğŸ’¾ ä¿å­˜å½•éŸ³</button>
        </div>

        <div class="log" id="logContainer">
            <div class="log-item">
                <span class="log-time">ç³»ç»Ÿå°±ç»ª</span><br>
                ç‚¹å‡»"å¯åŠ¨å”¤é†’è¯æ£€æµ‹"å¼€å§‹ä½¿ç”¨
            </div>
        </div>
    </div>

    <script>
        let recognition = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isListening = false;
        let isRecording = false;
        let recordingStream = null;
        let audioContext = null;
        let analyser = null;
        let silenceTimer = null;
        let silenceStartTime = null;
        let lastSoundTime = null;
        const SILENCE_THRESHOLD = 5000; // 5ç§’é™éŸ³
        const VOLUME_THRESHOLD = 0.01; // éŸ³é‡é˜ˆå€¼
        let currentAudioBlob = null; // å½“å‰å½•éŸ³çš„éŸ³é¢‘æ•°æ®
        let currentTranscript = null; // å½“å‰è¯†åˆ«ç»“æœ
        let currentFileName = null; // å½“å‰æ–‡ä»¶å

        // æ·»åŠ æ—¥å¿—
        function addLog(message) {
            const logContainer = document.getElementById('logContainer');
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            const time = new Date().toLocaleTimeString();
            logItem.innerHTML = `<span class="log-time">${time}</span><br>${message}`;
            logContainer.insertBefore(logItem, logContainer.firstChild);
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(icon, text, showWakeWord = false) {
            document.getElementById('statusBox').innerHTML = `
                <div class="status-icon">${icon}</div>
                <div class="status-text">${text}</div>
                ${showWakeWord ? '<span class="wake-word">ä½ å¥½å°ç¬”</span>' : ''}
            `;
        }

        // å¯åŠ¨å”¤é†’è¯æ£€æµ‹
        function startWakeWordDetection() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chromeæµè§ˆå™¨');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'zh-CN';

            recognition.onstart = function() {
                isListening = true;
                document.getElementById('btnStart').disabled = true;
                document.getElementById('btnStop').disabled = false;
                document.getElementById('statusBox').classList.add('listening');
                updateStatus('ğŸ‘‚', 'æ­£åœ¨ç›‘å¬å”¤é†’è¯...', true);
                addLog('âœ… å”¤é†’è¯æ£€æµ‹å·²å¯åŠ¨');
            };

            recognition.onresult = function(event) {
                const last = event.results.length - 1;
                const transcript = event.results[last][0].transcript.trim();
                
                console.log('è¯†åˆ«åˆ°:', transcript);
                
                // æ£€æµ‹å”¤é†’è¯
                if (transcript.includes('ä½ å¥½å°ç¬”') || 
                    transcript.includes('ä½ å¥½ å°ç¬”') ||
                    transcript.includes('ä½ å¥½å°æ¯”') ||
                    transcript.includes('å°ç¬”')) {
                    addLog(`ğŸ¯ æ£€æµ‹åˆ°å”¤é†’è¯: "${transcript}"`);
                    startRecording();
                }
            };

            recognition.onerror = function(event) {
                console.error('è¯†åˆ«é”™è¯¯:', event.error);
                addLog(`âŒ è¯†åˆ«é”™è¯¯: ${event.error}`);
            };

            recognition.onend = function() {
                if (isListening && !isRecording) {
                    recognition.start(); // è‡ªåŠ¨é‡å¯
                }
            };

            recognition.start();
        }

        // åœæ­¢å”¤é†’è¯æ£€æµ‹
        function stopWakeWordDetection() {
            if (recognition) {
                isListening = false;
                recognition.stop();
                document.getElementById('btnStart').disabled = false;
                document.getElementById('btnStop').disabled = true;
                document.getElementById('statusBox').classList.remove('listening');
                updateStatus('ğŸ›‘', 'æ£€æµ‹å·²åœæ­¢');
                addLog('â¹ï¸ å”¤é†’è¯æ£€æµ‹å·²åœæ­¢');
            }
        }

        // æ£€æµ‹éŸ³é‡å’Œé™éŸ³
        function detectSilence() {
            if (!analyser || !isRecording) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            // è®¡ç®—å¹³å‡éŸ³é‡
            const average = dataArray.reduce((a, b) => a + b) / dataArray.length / 255;
            
            // æ›´æ–°éŸ³é‡æŒ‡ç¤ºå™¨
            const volumeBar = document.getElementById('volumeBar');
            if (volumeBar) {
                volumeBar.style.width = (average * 100) + '%';
            }

            const now = Date.now();

            // æ£€æµ‹æ˜¯å¦æœ‰å£°éŸ³
            if (average > VOLUME_THRESHOLD) {
                lastSoundTime = now;
                silenceStartTime = null;
                document.getElementById('silenceTimer').textContent = '';
            } else {
                // å¼€å§‹è®¡ç®—é™éŸ³æ—¶é•¿
                if (!silenceStartTime) {
                    silenceStartTime = now;
                }
                
                const silenceDuration = now - silenceStartTime;
                const remainingTime = Math.ceil((SILENCE_THRESHOLD - silenceDuration) / 1000);
                
                if (remainingTime > 0) {
                    document.getElementById('silenceTimer').textContent = 
                        `é™éŸ³ ${remainingTime} ç§’åè‡ªåŠ¨åœæ­¢`;
                }

                // è¶…è¿‡5ç§’é™éŸ³åˆ™åœæ­¢å½•éŸ³
                if (silenceDuration >= SILENCE_THRESHOLD) {
                    addLog('ğŸ”‡ æ£€æµ‹åˆ°5ç§’é™éŸ³ï¼Œè‡ªåŠ¨åœæ­¢å½•éŸ³');
                    stopRecording('silence');
                    return;
                }
            }

            // ç»§ç»­æ£€æµ‹
            if (isRecording) {
                requestAnimationFrame(detectSilence);
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            if (isRecording) return;

            try {
                updateStatus('ğŸ™ï¸', 'æ­£åœ¨å½•éŸ³ï¼Œè¯·è¯´è¯...ï¼ˆ5ç§’æ— å£°éŸ³è‡ªåŠ¨åœæ­¢ï¼‰');
                document.getElementById('recordingIndicator').classList.add('active');
                document.getElementById('volumeIndicator').classList.add('show');
                document.getElementById('transcriptBox').classList.remove('show');
                document.getElementById('btnSave').disabled = false;
                document.getElementById('btnManual').textContent = 'â¹ï¸ åœæ­¢å½•éŸ³';
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recordingStream = stream;
                
                // åˆ›å»ºéŸ³é¢‘åˆ†æå™¨
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 256;

                // åˆå§‹åŒ–å½•éŸ³
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                isRecording = true;
                lastSoundTime = Date.now();
                silenceStartTime = null;

                mediaRecorder.ondataavailable = function(event) {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
                    // ä¿å­˜å½•éŸ³æ•°æ®
                    currentAudioBlob = audioBlob;
                    currentFileName = `recording_${Date.now()}.wav`;
                    
                    // è°ƒç”¨åç«¯é˜¿é‡Œäº‘NLSè¿›è¡Œè¯†åˆ«
                    recognizeWithCloud(audioBlob);
                    
                    // åœæ­¢æ‰€æœ‰éŸ³è½¨
                    if (recordingStream) {
                        recordingStream.getTracks().forEach(track => track.stop());
                    }
                    
                    // å…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡
                    if (audioContext) {
                        audioContext.close();
                        audioContext = null;
                    }
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    document.getElementById('btnSave').disabled = true;
                    document.getElementById('btnManual').textContent = 'æ‰‹åŠ¨å½•éŸ³';
                };

                mediaRecorder.start();
                addLog('ğŸ™ï¸ å¼€å§‹å½•éŸ³...ï¼ˆ5ç§’æ— å£°éŸ³è‡ªåŠ¨åœæ­¢ï¼Œæˆ–ç‚¹å‡»"ä¿å­˜å½•éŸ³"æ‰‹åŠ¨åœæ­¢ï¼‰');

                // å¼€å§‹æ£€æµ‹é™éŸ³
                detectSilence();

            } catch (error) {
                console.error('å½•éŸ³å¤±è´¥:', error);
                addLog(`âŒ å½•éŸ³å¤±è´¥: ${error.message}`);
                isRecording = false;
                document.getElementById('recordingIndicator').classList.remove('active');
                document.getElementById('volumeIndicator').classList.remove('show');
                document.getElementById('btnSave').disabled = true;
                document.getElementById('btnManual').textContent = 'æ‰‹åŠ¨å½•éŸ³';
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording(reason = 'manual') {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('recordingIndicator').classList.remove('active');
                document.getElementById('volumeIndicator').classList.remove('show');
                document.getElementById('silenceTimer').textContent = '';
                updateStatus('ğŸ”', 'æ­£åœ¨æœ¬åœ°è¯†åˆ«...');
                
                let reasonText = '';
                if (reason === 'silence') {
                    reasonText = 'ï¼ˆ5ç§’é™éŸ³ï¼‰';
                } else if (reason === 'save') {
                    reasonText = 'ï¼ˆæ‰‹åŠ¨ä¿å­˜ï¼‰';
                }
                addLog(`â¹ï¸ å½•éŸ³ç»“æŸ${reasonText}ï¼Œå¼€å§‹è¯†åˆ«...`);
            }
        }

        // æ‰‹åŠ¨å½•éŸ³/åœæ­¢
        async function manualRecord() {
            if (isRecording) {
                stopRecording('manual');
            } else {
                await startRecording();
            }
        }

        // ä¿å­˜å½•éŸ³
        function saveRecording() {
            if (!isRecording) {
                return;
            }
            
            addLog('ğŸ’¾ ç”¨æˆ·ç‚¹å‡»ä¿å­˜ï¼Œåœæ­¢å½•éŸ³');
            stopRecording('save');
        }

        // ä½¿ç”¨é˜¿é‡Œäº‘NLSè¯†åˆ«éŸ³é¢‘
        async function recognizeWithCloud(audioBlob) {
            const userId = document.getElementById('userId').value || 'user_001';
            const formData = new FormData();
            formData.append('file', audioBlob, currentFileName);
            formData.append('userId', userId);

            try {
                updateStatus('â˜ï¸', 'æ­£åœ¨è°ƒç”¨é˜¿é‡Œäº‘NLSè¯†åˆ«...');
                document.getElementById('transcriptBox').classList.add('show');
                document.getElementById('transcriptText').textContent = 'æ­£åœ¨è¯†åˆ«ï¼Œè¯·ç¨å€™...';
                document.getElementById('confirmButtons').style.display = 'none';
                addLog('â˜ï¸ æ­£åœ¨è°ƒç”¨é˜¿é‡Œäº‘NLSè¿›è¡Œè¯­éŸ³è¯†åˆ«...');

                const response = await fetch('/api/audio/recognize', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.transcript) {
                        // ä¿å­˜è¯†åˆ«ç»“æœï¼ˆä¸åŒ…å«ossUrlï¼Œå› ä¸ºè¿˜æ²¡ä¸Šä¼ ï¼‰
                        currentTranscript = result.transcript;
                        
                        // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
                        document.getElementById('transcriptText').textContent = result.transcript;
                        document.getElementById('confirmButtons').style.display = 'flex';
                        updateStatus('âœ…', 'è¯†åˆ«å®Œæˆï¼Œè¯·ç¡®è®¤æ˜¯å¦ä¿å­˜');
                        addLog(`âœ… NLSè¯†åˆ«æˆåŠŸ: ${result.transcript.substring(0, 50)}${result.transcript.length > 50 ? '...' : ''}`);
                    } else {
                        throw new Error('æœªè·å–åˆ°è¯†åˆ«ç»“æœ');
                    }
                } else {
                    throw new Error(`è¯†åˆ«å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                console.error('è¯†åˆ«é”™è¯¯:', error);
                addLog(`âŒ è¯†åˆ«å¤±è´¥: ${error.message}`);
                document.getElementById('transcriptText').textContent = 
                    `è¯†åˆ«å¤±è´¥: ${error.message}\n\næ‚¨å¯ä»¥ç‚¹å‡»"æ”¾å¼ƒ"åé‡æ–°å½•éŸ³ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜æ£€æŸ¥é…ç½®ã€‚`;
                document.getElementById('confirmButtons').style.display = 'flex';
                updateStatus('âŒ', 'è¯†åˆ«å¤±è´¥');
            }
        }

        // ç¡®è®¤ä¿å­˜åˆ°æ•°æ®åº“
        async function confirmUpload() {
            if (!currentTranscript || !currentAudioBlob) {
                addLog('âŒ ç¼ºå°‘è¯†åˆ«æ•°æ®æˆ–éŸ³é¢‘æ–‡ä»¶');
                return;
            }

            document.getElementById('confirmButtons').style.display = 'none';
            updateStatus('ğŸ’¾', 'æ­£åœ¨ä¸Šä¼ å¹¶ä¿å­˜åˆ°æ•°æ®åº“...');
            addLog('ğŸ’¾ ç”¨æˆ·ç¡®è®¤ä¿å­˜ï¼Œæ­£åœ¨ä¸Šä¼ åˆ°OSSå¹¶å†™å…¥æ•°æ®åº“...');

            try {
                const userId = document.getElementById('userId').value || 'user_001';
                const formData = new FormData();
                
                // é‡æ–°å‘é€éŸ³é¢‘æ–‡ä»¶ï¼ˆè¿™æ¬¡ä¼šä¸Šä¼ åˆ°OSSå¹¶ä¿å­˜ï¼‰
                formData.append('file', currentAudioBlob, currentFileName);
                formData.append('transcript', currentTranscript);
                formData.append('userId', userId);

                const response = await fetch('/api/audio/save', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // æ„é€ è¯¦ç»†çš„ä¿å­˜ç»“æœæ˜¾ç¤º
                    const displayText = `ğŸ“ è¯†åˆ«æ–‡æœ¬ï¼š\n${result.transcript}\n\n` +
                        `âœ… å·²æˆåŠŸä¿å­˜åˆ°äº‘ç«¯æ•°æ®åº“ï¼\n\n` +
                        `ğŸ“Š ä¿å­˜ä¿¡æ¯ï¼š\n` +
                        `â€¢ è®°å½•ID: ${result.recordId}\n` +
                        `â€¢ æ–‡ä»¶å: ${result.fileName}\n` +
                        `â€¢ å‘é‡ç»´åº¦: ${result.vectorDimension}\n` +
                        `â€¢ ä¿å­˜æ—¶é—´: ${result.saveTime}\n` +
                        `â€¢ OSS URL: ${result.ossUrl}`;
                    
                    document.getElementById('transcriptText').textContent = displayText;
                    updateStatus('âœ…', 'å·²æˆåŠŸä¿å­˜ï¼', false);
                    
                    // è¯¦ç»†æ—¥å¿—è®°å½•
                    console.log('========================================');
                    console.log('ä¿å­˜æˆåŠŸè¯¦æƒ…:');
                    console.log('è¯†åˆ«æ–‡æœ¬:', result.transcript);
                    console.log('è®°å½•ID:', result.recordId);
                    console.log('æ–‡ä»¶å:', result.fileName);
                    console.log('å‘é‡ç»´åº¦:', result.vectorDimension);
                    console.log('OSS URL:', result.ossUrl);
                    console.log('ä¿å­˜æ—¶é—´:', result.saveTime);
                    console.log('========================================');
                    
                    // æ·»åŠ åˆ°æ“ä½œæ—¥å¿—
                    addLog(`âœ… ä¿å­˜æˆåŠŸ - è®°å½•ID: ${result.recordId}`);
                    addLog(`ğŸ“ è¯†åˆ«æ–‡æœ¬: ${result.transcript}`);
                    addLog(`ğŸ“ æ–‡ä»¶: ${result.fileName}`);
                    addLog(`ğŸ”¢ å‘é‡ç»´åº¦: ${result.vectorDimension}`);
                    
                    // æ¸…ç©ºæ•°æ®
                    currentAudioBlob = null;
                    currentTranscript = null;
                    
                    // 8ç§’åæ¢å¤ç›‘å¬ï¼ˆç»™ç”¨æˆ·è¶³å¤Ÿæ—¶é—´æŸ¥çœ‹ç»“æœï¼‰
                    setTimeout(() => {
                        if (isListening) {
                            updateStatus('ğŸ‘‚', 'æ­£åœ¨ç›‘å¬å”¤é†’è¯...', true);
                        } else {
                            updateStatus('ğŸ‘‚', 'å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…å”¤é†’');
                        }
                        document.getElementById('transcriptBox').classList.remove('show');
                    }, 8000);
                    
                } else {
                    throw new Error(`ä¿å­˜å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                console.error('ä¿å­˜é”™è¯¯:', error);
                addLog(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`);
                alert(`ä¿å­˜å¤±è´¥: ${error.message}\n\nè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸ã€‚`);
                document.getElementById('confirmButtons').style.display = 'flex';
            }
        }

        // å–æ¶ˆä¿å­˜
        function cancelUpload() {
            currentAudioBlob = null;
            currentTranscript = null;
            document.getElementById('transcriptBox').classList.remove('show');
            document.getElementById('confirmButtons').style.display = 'none';
            addLog('âœ• ç”¨æˆ·å–æ¶ˆä¿å­˜ï¼Œå½•éŸ³å·²ä¸¢å¼ƒ');
            
            // æ¢å¤ç›‘å¬çŠ¶æ€
            if (isListening) {
                updateStatus('ğŸ‘‚', 'æ­£åœ¨ç›‘å¬å”¤é†’è¯...', true);
            } else {
                updateStatus('ğŸ‘‚', 'å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…å”¤é†’');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            addLog('ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        };
    </script>
</body>
</html>

